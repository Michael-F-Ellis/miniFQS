<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>miniFQS - Scorewriter</title>
    <style>
        /* --- RESET & BASICS --- */
        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- TOOLBAR --- */
        header {
            background: #2c3e50;
            color: white;
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
        }

        button {
            background: #34495e;
            color: white;
            border: 1px solid #455a64;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        button:hover {
            background: #455a64;
        }

        button:active {
            background: #1abc9c;
            border-color: #1abc9c;
        }

        button.primary {
            background: #16a085;
            border-color: #16a085;
        }

        button.primary:hover {
            background: #1abc9c;
        }

        /* --- WORKSPACE (Split View) --- */
        #workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #f0f2f5;
        }

        /* Editor Pane (Hidden by default via width) */
        #editor-pane {
            width: 0;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease-in-out;
            overflow: hidden;
        }

        /* When active, editor takes 40% width (or 50%, adjustable) */
        #workspace.editor-open #editor-pane {
            width: 40%;
            min-width: 300px;
        }

        textarea {
            flex: 1;
            width: 100%;
            resize: none;
            border: none;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
            color: #333;
            white-space: pre;
            overflow-x: auto;
        }

        textarea:focus {
            background: #fafafa;
        }

        /* Preview Pane */
        #preview-pane {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center the score sheet visually */
        }

        /* The Component Wrapper */
        mini-fqs {
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px;
            /* Reasonable max width for reading */
            border-radius: 4px;
            /* Min height to look like a sheet of paper */
            min-height: 400px;
        }

        /* --- PRINT STYLES --- */
        @media print {

            header,
            #editor-pane {
                display: none !important;
            }

            #workspace {
                display: block;
                height: auto;
                overflow: visible;
                background: white;
            }

            #preview-pane {
                padding: 0;
                overflow: visible;
                display: block;
            }

            mini-fqs {
                box-shadow: none;
                max-width: none;
                width: 100%;
                border: none;
                min-height: 0;
            }

            body,
            html,
            #app {
                height: auto;
                overflow: visible;
                background: white;
            }
        }
    </style>
</head>

<body>

    <div id="app">
        <header>
            <div class="toolbar-group">
                <h1>miniFQS</h1>
                <span id="filename-display"
                    style="font-size: 0.8em; color: #bdc3c7; margin-left: 10px; padding-top:4px;">(unsaved)</span>
            </div>
            <div class="toolbar-group">
                <input type="file" id="file-input" accept=".mfqs,.txt" style="display: none;">

                <button onclick="app.newFile()">New</button>
                <button onclick="app.openFile()">Open...</button>
                <button onclick="app.saveFile()">Save</button>
                <button onclick="window.print()">Print</button>
                <div style="width: 1px; background: #455a64; margin: 0 5px;"></div>
                <button class="primary" onclick="app.toggleEditor()">Toggle Editor</button>
            </div>
        </header>

        <div id="workspace">
            <div id="preview-pane">
                <mini-fqs id="score-renderer"></mini-fqs>
            </div>
            <div id="editor-pane">
                <textarea id="source-editor" spellcheck="false" placeholder="Enter FQS code here..."></textarea>
            </div>
        </div>
    </div>

    <!-- Load Web Component -->
    <script type="module" src="./mini-fqs.js"></script>

    <!-- Application Logic -->
    <script>
        const DEFAULT_SCORE = `New Score

c d e f | g a b c |
K0 c d e f | g a b c |`;

        const app = {
            currentFilename: 'score.mfqs',
            editorOpen: false,

            init() {
                this.editor = document.getElementById('source-editor');
                this.renderer = document.getElementById('score-renderer');
                this.workspace = document.getElementById('workspace');
                this.fileInput = document.getElementById('file-input');
                this.filenameDisplay = document.getElementById('filename-display');

                // 1. Set Default Content
                this.editor.value = DEFAULT_SCORE;
                this.updateRenderer();

                // 2. Bind Editor Events (Debounced)
                let debounceTimer;
                this.editor.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => this.updateRenderer(), 300);
                });

                // 3. Bind File Input Event
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
            },

            updateRenderer() {
                // Push text to component
                this.renderer.score = this.editor.value;
            },

            toggleEditor() {
                this.editorOpen = !this.editorOpen;
                if (this.editorOpen) {
                    this.workspace.classList.add('editor-open');
                    // Focus text area after transition
                    setTimeout(() => this.editor.focus(), 300);
                } else {
                    this.workspace.classList.remove('editor-open');
                }
            },

            newFile() {
                if (confirm("Create new score? Unsaved changes will be lost.")) {
                    this.editor.value = DEFAULT_SCORE;
                    this.currentFilename = 'score.mfqs';
                    this.updateFilenameDisplay();
                    this.updateRenderer();
                }
            },

            openFile() {
                this.fileInput.click();
            },

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.editor.value = e.target.result;
                    this.currentFilename = file.name;
                    this.updateFilenameDisplay();
                    this.updateRenderer();

                    // If editor is closed, maybe open it? Or leave it closed.
                    // Leaving it as user preference for now.
                };
                reader.readAsText(file);

                // Reset input so same file can be selected again
                event.target.value = '';
            },

            saveFile() {
                const text = this.editor.value;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = this.currentFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            updateFilenameDisplay() {
                this.filenameDisplay.textContent = this.currentFilename;
            }
        };

        // Initialize on Load
        window.addEventListener('DOMContentLoaded', () => app.init());

        // Expose app to global scope for button onclick handlers
        window.app = app;
    </script>

</body>

</html>