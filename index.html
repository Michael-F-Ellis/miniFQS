<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>miniFQS - Scorewriter</title>
    <!-- abcjs audio controls CSS with local fallback -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/abcjs@6.5.2/abcjs-audio.css"
        onerror="this.onerror=null;this.href='abcjs-audio.css';">
    <link rel="stylesheet" href="abcjs-audio.css">
    <style>
        /* --- RESET & BASICS --- */
        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- TOOLBAR --- */
        header {
            background: #2c3e50;
            color: white;
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
        }

        button {
            background: #34495e;
            color: white;
            border: 1px solid #455a64;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        button:hover {
            background: #455a64;
        }

        button:active {
            background: #1abc9c;
            border-color: #1abc9c;
        }

        button.primary {
            background: #16a085;
            border-color: #16a085;
        }

        button.primary:hover {
            background: #1abc9c;
        }

        /* --- WORKSPACE (Split View) --- */
        #workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #f0f2f5;
        }

        /* Editor Pane (Hidden by default via width) */
        #editor-pane {
            width: 0;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease-in-out;
            overflow: hidden;
        }

        /* When active, editor takes 40% width (or 50%, adjustable) */
        #workspace.editor-open #editor-pane {
            width: 50%;
            min-width: 300px;
        }

        textarea {
            flex: 1;
            width: 100%;
            resize: none;
            border: none;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            outline: none;
            color: #333;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        textarea:focus {
            background: #fafafa;
        }

        /* Preview Pane */
        #preview-pane {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center the score sheet visually */
        }

        /* The Component Wrapper */
        mini-fqs {
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px;
            /* Reasonable max width for reading */
            border-radius: 4px;
            /* Min height to look like a sheet of paper */
            min-height: 400px;
        }

        /* --- ABC NOTATION SECTION --- */
        #abc-section {
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px;
            border-radius: 4px;
            margin-top: 20px;
            padding: 15px;
        }

        .abc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .abc-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .abc-toggle {
            background: #3498db;
            border-color: #3498db;
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .abc-toggle:hover {
            background: #2980b9;
        }

        #abc-container {
            min-height: 150px;
            overflow: auto;
            position: relative;
        }

        #abc-container .loading {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 40px;
        }

        #abc-container .error {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #fadbd8;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .abc-rendering {
            width: 100%;
            overflow-x: auto;
        }

        .abc-source {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .abc-playback {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .abc-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* ABCJS playback controls styling - Minimal overrides to avoid conflicts */
        .abc-playback {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hide the CSS warning that appears when abcjs-audio.css loads */
        .abcjs-css-warning {
            display: none !important;
        }

        /* Ensure abcjs controls are properly contained */
        .abc-playback .abcjs-inline-audio {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Fix for nested abcjs-inline-audio divs if they occur */
        .abcjs-inline-audio .abcjs-inline-audio {
            width: 100%;
        }

        /* --- PRINT STYLES --- */
        @media print {

            header,
            #editor-pane,
            #abc-section {
                display: none !important;
            }

            #workspace {
                display: block;
                height: auto;
                overflow: visible;
                background: white;
            }

            #preview-pane {
                padding: 0;
                overflow: visible;
                display: block;
            }

            mini-fqs {
                box-shadow: none;
                max-width: none;
                width: 100%;
                border: none;
                min-height: 0;
            }

            body,
            html,
            #app {
                height: auto;
                overflow: visible;
                background: white;
            }
        }
    </style>
</head>

<body>

    <div id="app">
        <header>
            <div class="toolbar-group">
                <h1>miniFQS</h1>
                <span id="filename-display"
                    style="font-size: 0.8em; color: #bdc3c7; margin-left: 10px; padding-top:4px;">(unsaved)</span>
            </div>
            <div class="toolbar-group">
                <input type="file" id="file-input" accept=".mfqs,.txt" style="display: none;">

                <button onclick="app.newFile()">New</button>
                <button onclick="app.openFile()">Open...</button>
                <button onclick="app.saveFile()">Save</button>
                <button onclick="window.print()">Print</button>
                <div style="width: 1px; background: #455a64; margin: 0 5px;"></div>
                <button onclick="app.debugPipeline()">Debug</button>
                <button class="primary" onclick="app.toggleEditor()">Toggle Editor</button>
            </div>
        </header>

        <div id="workspace">
            <div id="preview-pane">
                <mini-fqs id="score-renderer"></mini-fqs>

                <!-- ABC Notation Section -->
                <div id="abc-section" class="abc-section">
                    <div class="abc-header">
                        <h3>ABC Notation</h3>
                        <button id="toggle-abc-source" class="abc-toggle">Show Source</button>
                    </div>
                    <div id="abc-container" class="abc-container">
                        <!-- ABC notation will be rendered here -->
                    </div>
                    <div id="abc-source" class="abc-source" style="display: none;">
                        <pre><code id="abc-source-code"></code></pre>
                    </div>
                    <div id="abc-playback" class="abc-playback">
                        <!-- MIDI playback controls will be inserted here -->
                    </div>
                    <div id="abc-error" class="abc-error" style="display: none;">
                        <!-- Error messages will be shown here -->
                    </div>
                </div>
            </div>
            <div id="editor-pane">
                <textarea id="source-editor" spellcheck="false" wrap="soft"
                    placeholder="Enter FQS code here..."></textarea>
            </div>
        </div>
    </div>

    <!-- Load ABCJS Library -->
    <script src="./tutorial/lib/abcjs-basic-min.js"></script>

    <!-- Load Web Component -->
    <script type="module" src="./mini-fqs.js"></script>

    <!-- Load ABC Pipeline -->
    <script type="module" src="./browser-pipeline-final.js"></script>

    <!-- Load ABC Integration -->
    <script type="module" src="./abc-integration.js"></script>

    <!-- Application Logic -->
    <script>
        const DEFAULT_SCORE = `New Score

c d e f | g a b c |
K0 c d e f | g a b c |`;

        const app = {
            currentFilename: 'score.mfqs',
            editorOpen: false,
            abcIntegration: null,
            abcDebounceTimer: null,

            init() {
                this.editor = document.getElementById('source-editor');
                this.renderer = document.getElementById('score-renderer');
                this.workspace = document.getElementById('workspace');
                this.fileInput = document.getElementById('file-input');
                this.filenameDisplay = document.getElementById('filename-display');

                // 1. Set Default Content
                this.editor.value = DEFAULT_SCORE;
                this.updateRenderer();
                this.updateABCNotation();

                // 2. Bind Editor Events (Debounced)
                let debounceTimer;
                this.editor.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => this.updateRenderer(), 300);

                    // Also update ABC notation with separate debounce
                    this.debounceABCUpdate();
                });

                // 3. Bind File Input Event
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

                // 4. Initialize ABC integration
                this.initABCIntegration();
            },

            initABCIntegration() {
                // Wait for abcIntegration to be available
                const checkABC = () => {
                    if (window.abcIntegrationAPI) {
                        this.abcIntegration = window.abcIntegrationAPI;
                        console.log('ABC integration initialized');
                        // Update ABC with current score
                        this.updateABCNotation();
                    } else {
                        setTimeout(checkABC, 100);
                    }
                };
                checkABC();
            },

            debounceABCUpdate() {
                clearTimeout(this.abcDebounceTimer);
                this.abcDebounceTimer = setTimeout(() => {
                    this.updateABCNotation();
                }, 500); // Slightly longer debounce for ABC conversion
            },

            updateRenderer() {
                // Push text to component
                this.renderer.score = this.editor.value;
            },

            updateABCNotation() {
                if (!this.abcIntegration) {
                    // Try to get it directly
                    if (window.abcIntegration && window.abcIntegration.updateABCNotation) {
                        const elements = {
                            container: document.getElementById('abc-container'),
                            sourceCode: document.getElementById('abc-source-code'),
                            playback: document.getElementById('abc-playback'),
                            error: document.getElementById('abc-error')
                        };
                        window.abcIntegration.updateABCNotation(this.editor.value, elements);
                    }
                    return;
                }

                this.abcIntegration.update(this.editor.value);
            },

            toggleEditor() {
                this.editorOpen = !this.editorOpen;
                if (this.editorOpen) {
                    this.workspace.classList.add('editor-open');
                    // Focus text area after transition
                    setTimeout(() => this.editor.focus(), 300);
                } else {
                    this.workspace.classList.remove('editor-open');
                }
            },

            newFile() {
                if (confirm("Create new score? Unsaved changes will be lost.")) {
                    this.editor.value = DEFAULT_SCORE;
                    this.currentFilename = 'score.mfqs';
                    this.updateFilenameDisplay();
                    this.updateRenderer();
                    this.updateABCNotation();
                }
            },

            openFile() {
                this.fileInput.click();
            },

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.editor.value = e.target.result;
                    this.currentFilename = file.name;
                    this.updateFilenameDisplay();
                    this.updateRenderer();
                    this.updateABCNotation();

                    // If editor is closed, maybe open it? Or leave it closed.
                    // Leaving it as user preference for now.
                };
                reader.readAsText(file);

                // Reset input so same file can be selected again
                event.target.value = '';
            },

            saveFile() {
                const text = this.editor.value;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = this.currentFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            updateFilenameDisplay() {
                this.filenameDisplay.textContent = this.currentFilename;
            },

            debugPipeline() {
                if (!window.fqsPipeline || !window.fqsPipeline.debugPipeline) {
                    alert('Pipeline debug not available. Make sure browser-pipeline-final.js is loaded.');
                    return;
                }

                const fqsText = this.editor.value;
                const result = window.fqsPipeline.debugPipeline(fqsText);

                console.log('Pipeline Debug Result:', result);

                if (result.success) {
                    const message = `Pipeline Debug Results:\n\n` +
                        `Parse Stage: ${result.stages[0]?.duration?.toFixed(2)}ms\n` +
                        `Convert Stage: ${result.stages[1]?.duration?.toFixed(2)}ms\n` +
                        `Total: ${(result.stages[0]?.duration + result.stages[1]?.duration).toFixed(2)}ms\n\n` +
                        `ABC Notation:\n${result.abc}`;

                    alert(message);
                } else {
                    alert(`Pipeline Debug Failed:\n${result.error}`);
                }
            }
        };

        // Initialize on Load
        window.addEventListener('DOMContentLoaded', () => app.init());

        // Expose app to global scope for button onclick handlers
        window.app = app;
    </script>

</body>

</html>