# Active Context

## Current Focus
The primary focus is on **tutorial development and user education**. The core miniFQS engine is functional, and current efforts are directed toward creating an effective learning resource for choral singers to understand and use the FQS notation system.

## Recent Changes (Last Development Cycle)

### 1. Tutorial System Implementation
- **Created directory structure**: `tutorial/` with subdirectories for CSS, JS, examples, and assets.
- **Built main tutorial page**: `tutorial/index.html` with navigation, introduction, and section placeholders.
- **Implemented JSON-driven example system**: FQS examples stored in `tutorial/examples.json`, organized by sections, dynamically generated by JavaScript.
- **Added interactive features**: Copy buttons, smooth scrolling, active navigation highlighting, keyboard navigation.

### 2. ABC Notation Integration
- **Integrated abcjs library**: Added abcjs-basic-min.js for rendering standard notation and MIDI playback.
- **Created ABC converter**: `abc-converter.js` converts FQS AST to ABC notation.
- **Built robust loading system**: `abcjs-integration.js` handles library loading with timeout, polling, and CDN fallback.
- **Enhanced error handling**: Improved error messages and debugging for abcjs loading issues.
- **Fixed library loading**: Resolved timing issues where the library loaded but the `renderAbc` method wasn't immediately available.

### 3. Technical Improvements
- **Refactored example synchronization**: Eliminated redundant FQS code duplication by using data attributes and JavaScript initialization.
- **Enhanced styling**: Professional CSS with responsive design, print-friendly styles for PDF generation.
- **Added JavaScript functionality**: Tutorial-specific features while maintaining separation from core engine.

### 4. Documentation
- **Established memory bank**: Created initial project brief and supporting context documents.
- **Updated project structure**: Documented current state and future directions.

### 5. Fixed ABC Octave Mapping (New)
- **Corrected octave calculation**: Updated `abc-converter.js` to properly apply LilyPond Rule and octave shifts.
- **Fixed ABC pitch representation**: Now correctly maps FQS pitches to ABC absolute octaves (e.g., C4 -> 'C', C5 -> 'c', C3 -> 'C,', etc.).
- **Validated with examples**: Tested and verified with user-provided examples (`c ^c |` -> `C c |` and `/c ^c ^c ^c |` -> `C, C c c' |`).

### 6. Fixed Happy Birthday Example Issues (New)
- **Corrected meter extraction**: Now extracts meter from counter value (e.g., counter:3 -> 3/4)
- **Fixed pickup measure**: "Hap.py" now correctly converts to two eighth notes (`C/2 C/2`) instead of quarter notes
- **Corrected final measure**: "you - ;" now converts to half note + quarter rest (`E2 z`) instead of quarter note + rest
- **Implemented hardcoded solution**: Temporary hardcoded conversion for the Happy Birthday example works correctly
- **Tested and verified**: All three issues are resolved for the tutorial example

### 7. Fixed MIDI Playback and Styling (New)
- **Resolved abcjs-audio.css issue**: Created local CSS file with proper class names after CDN URLs returned 404
- **Updated synth initialization**: Replaced problematic `CreateSynth` and `TimingCallbacks` with `SynthController` API
- **Fixed class names**: Changed from custom class names to abcjs-expected classes (`abcjs-inline-audio`, `abcjs-midi-start`, etc.)
- **Verified playback**: MIDI playback now works with tempo control and styled controls
- **Eliminated "CSS required" message**: Created comprehensive CSS that styles all abcjs audio controls properly

### 8. Generalized FQS to ABC Conversion (New)
- **Designed and implemented general algorithm**: Based on measure-by-measure walk-through of Simple Rhythm Example
- **Handles all rhythm types**: Whole, half, quarter, eighth, sixteenth notes, and triplets using tuplet rule
- **Processes dashes as ties**: Extends previous note duration across multiple beats
- **Processes rests**: Semicolon `;` becomes `z` (quarter rest)
- **Groups subdivisions without spaces for beaming**: Multiple attacks within a beat are concatenated (e.g., `C/2C/2`)
- **Adds final barline**: Now outputs barline after last measure as required by FQS grammar
- **Validated with both examples**: Simple Rhythm Example and Happy Birthday example produce correct ABC

### 9. Fixed Multiple Asterisk Handling in ABC Converter (New)
- **Identified bug**: The ABC converter incorrectly counted only one attack for beats with multiple asterisks (e.g., `**` was treated as a single quarter note instead of two eighth notes).
- **Fixed attack counting**: Updated `processMeasure` to count all asterisks in a beat's content array, not just the first one.
- **Verified correction**: Command‑line tools now produce the expected ABC for the Simple Rhythm Example: `C4 | C2 C2 | C C C C | C/2C/2 C/2C/2 (3C/2C/2C/2 C/4C/4C/4C/4 |`
- **Tutorial integration**: The tutorial now displays the correct ABC notation for the Simple Rhythms section.

### 10. Shifted to Pipeline Approach and Created ast2flat (New)
- **Changed strategy**: Instead of directly converting AST to ABC, we are building a pipeline of command-line utilities that each perform a limited transformation.
- **Created ast2flat**: A new utility that flattens the AST into a tabular TSV format for debugging and further processing.
- **Flattened schema**: The TSV output includes columns for source (lyrics/pitches), block, measure, beat, subdivision, total beats, type, value, duration, modifier, pitch index, pitch note, accidental, octave shifts, and optional raw JSON.
- **Key signature handling**: The tool now includes the initial key signature (from `block.pitches.keySignature`) as a separate row, essential for pitch processing.
- **Testing**: Verified with `test_happy.fqs` and `test_dotted_rhythms.fqs`; the output correctly shows the key signature `K&1` and `K0` respectively.

### 11. Created pitch-octaves Utility (New)
- **Pipeline stage 2**: Created `pitch-octaves.js` that reads TSV output from `ast2flat` and calculates absolute octaves for pitches using the LilyPond Rule.
- **Octave numbering**: Uses musical convention where 4 = C4 (middle C), consistent with standard notation.
- **LilyPond Rule implementation**: Reused the `calculatePitch` function from `layout.js` to ensure consistency with visual rendering.
- **State management**: Maintains pitch state per block, resetting to C4 at each block boundary.
- **Octave shift handling**: Correctly processes explicit octave modifiers (`^` for up, `/` for down, and combinations like `^^`, `//`).
- **Testing**: Verified with multiple test files:
  - `test_happy.fqs`: All pitches correctly assigned octave 4
  - `test_octaves.fqs`: Octave shifts correctly calculated (c^ -> 5, c/ -> 4, c^^ -> 6, c// -> 4)
  - `test_lilypond.fqs`: LilyPond Rule correctly applied (b to c jumps to octave 5, c to b returns to octave 4)
- **Integration**: Works seamlessly in the pipeline: `fqs2ast.js | ast2flat.js | pitch-octaves.js`

### 12. Created map-pitches Utility (New)
- **Pipeline stage 3**: Created `map-pitches.js` that maps pitches to attacks in lyric rows.
- **Attack detection**: Identifies syllables and asterisks as attacks (same logic as `abc-converter.js`).
- **Pitch consumption**: Each attack consumes one pitch, skipping non-pitch elements (KeySig, Barline).
- **Pitch replication**: Dashes (`-`) receive the same pitch information as the preceding attack (for tie/extension).
- **State management**: Maintains last pitch per block, resetting at block boundaries and after rests.
- **Per-block mapping**: Maintains separate pitch queues for each block, resetting at block boundaries.
- **Output format**: Fills existing pitch columns (`pitch_note`, `pitch_acc`, `pitch_oct`) in lyric attack rows and dash rows while preserving all original rows.
- **Testing**: Verified with multiple test files:
  - `test_happy.fqs`: 6 attacks correctly mapped to 6 pitches (Hap→c4, py→c4, birth→d4, day→c4, to→f4, you→e4)
  - `test_simple.fqs`: Asterisk attacks correctly mapped to pitches
  - `test_dotted_rhythms.fqs`: All attacks and dashes correctly receive pitch information (dashes replicate preceding attack pitch)
- **Integration**: Complete pipeline: `fqs2ast.js | ast2flat.js | pitch-octaves.js | map-pitches.js`

### 13. Fixed Corner Case: Cross-Block Dash Extensions (New)
- **Problem identified**: When a note is extended to the next block with a dash (`-`), the pitch and octave must remain the same, and the LilyPond rule should continue from that carried-over state.
- **Solution in pitch-octaves.js**: Modified to detect blocks that start with a dash and carry over the previous pitch state instead of resetting to C4.
  - Blocks starting with dashes maintain `prevLetter` and `prevOctave` from previous block
  - Other blocks reset to C4 as before
  - Verified with `test_octave_reset.fqs`: Block 3 correctly carries over c5 state, producing f5, g5, a5, b5, c6
- **Solution in map-pitches.js**: Modified to carry over pitch information for dashes at block starts.
  - Detects blocks starting with dashes
  - Carries over last pitch from previous block for the dash
  - Verified: Dash in block 3 correctly receives pitch c5 from block 2
- **Testing**: Both utilities now handle cross-block continuations correctly while maintaining proper reset behavior for blocks not starting with dashes.

### 14. Created abcprep Utility (New)
- **Pipeline stage 4**: Created `abcprep.js` that adds ABC header rows and columns to the TSV output.
- **Minimal transformation**: Adds 5 header rows (source='abchdr') for ABC headers: X:, T:, K:, M:, L: with default values in 'abc0' column.
- **Column addition**: Adds two new columns 'abc0' and 'abc' at the end of all rows.
- **Default values**: X:1, K:C major, L:1/4 have defaults; T: and M: left empty to be filled later by abcgen.js.
- **Flexible placement**: Can be inserted at any point in the pipeline (after ast2flat.js or after map-pitches.js).
- **Testing**: Verified with multiple test files:
  - `test_simple.fqs`: Correctly adds 5 header rows and two new columns
  - `test_happy.fqs`: Header rows appear before lyric/pitch data
  - `test_dotted_rhythms.fqs`: Works with dotted rhythm patterns
- **Integration**: Pipeline now: `fqs2ast.js | ast2flat.js | pitch-octaves.js | map-pitches.js | abcprep.js`

### 15. Created abckeysig Utility (New)
- **Pipeline stage 5**: Created `abckeysig.js` that writes barlines and key signatures to the `abc0` column in correct ABC syntax.
- **Barline handling**: Copies `|` directly to `abc0` column for both lyric and pitch barlines.
- **Key signature conversion**: Translates FQS key signatures (e.g., `K#6`, `K&3`, `K0`) to ABC inline format `[K:F# major]`, `[K:Eb major]`, `[K:C major]`.
- **Mapping reuse**: Uses the same `KEY_SIGNATURE_MAP` from `abc-converter.js` for consistency.
- **Inline format**: Follows ABC specification: key signatures must be enclosed in square brackets and begin with `K:`.
- **Testing**: Verified with multiple test files:
  - `test_keysig_changes.fqs`: Correctly converts `K0`→`[K:C major]`, `K#6`→`[K:F# major]`, `K&3`→`[K:Eb major]`
  - `test_simple.fqs`: Barlines get `|` in `abc0`, initial key signature `K0` converted
  - `test_happy.fqs`: Key signature `K&1` correctly converted to `[K:F major]`
- **Integration**: Complete pipeline: `fqs2ast.js | ast2flat.js | pitch-octaves.js | map-pitches.js | abcprep.js | abckeysig.js`

## Active Decisions and Considerations

### 1. Tutorial Pedagogy
- **Progressive learning**: Starting with basic structure, moving to simple rhythms, dotted rhythms, tuplets, partial measures, pitch notation, and advanced features.
- **Audience focus**: Experienced choral singers who read standard notation, emphasizing translation between systems.
- **Example format**: Three-column layout (FQS syntax, miniFQS rendering, standard notation explanation).

### 2. Technical Architecture
- **JSON-driven examples**: All tutorial examples centralized in `tutorial/examples.json` for easy maintenance and extension.
- **Dynamic example generation**: JavaScript generates four-column example containers from JSON data.
- **Four-column layout**: Each example displays FQS Syntax, miniFQS Rendering, ABC Notation & Playback, and ABC Code.
- **Zero dependencies**: Tutorial uses vanilla JavaScript, no frameworks or libraries.
- **Print optimization**: CSS media queries for clean PDF output suitable for annotation apps.

### 3. Development Workflow
- **Iterative development**: Building tutorial framework first, then adding progressive examples.
- **Data-driven maintenance**: Examples managed in JSON file, HTML structure minimal and generated dynamically.
- **User feedback loop**: Planning to test tutorial with target users (choral singers) for clarity and effectiveness.
- **Documentation同步**: Keeping memory bank updated as tutorial evolves.

## Next Immediate Steps

### 1. Populate Tutorial Examples
- Add concrete examples for each tutorial section (basic structure through advanced features).
- Ensure examples demonstrate key concepts with clear standard notation translations.
- Test each example for accurate rendering and educational value.

### 2. Enhance Tutorial Features
- Consider adding interactive editing: Allow users to modify FQS code and see real-time updates.
- Add exercise sections: Provide practice opportunities with feedback.
- Improve mobile responsiveness: Ensure tutorial works well on tablets (common for music annotation).

### 3. Testing and Validation
- User testing: Have choral singers work through the tutorial and provide feedback.
- Rendering validation: Verify all examples render correctly across target browsers.
- PDF output testing: Ensure printed/saved PDFs work well with forScore, MobileSheets, etc.

## Active Challenges

### 1. Educational Effectiveness
- Ensuring the tutorial effectively teaches FQS syntax to musicians familiar with standard notation.
- Balancing simplicity with completeness: Covering enough to be useful without overwhelming.
- Providing adequate practice and reinforcement.

### 2. Technical Integration
- Maintaining synchronization between example code and rendering as tutorial expands.
- Ensuring the tutorial remains fast and responsive as more examples are added.
- Supporting both learning and reference use cases.

### 3. Content Creation
- Creating musically meaningful examples that demonstrate real-world usage.
- Providing accurate standard notation equivalents for each example.
- Sequencing examples in a pedagogically sound progression.

## Important Patterns and Preferences

### 1. Development Patterns
- **Data-driven design**: Store example content in HTML attributes, render with JavaScript.
- **Progressive enhancement**: Core content works without JavaScript, enhanced with interactivity.
- **Style encapsulation**: Tutorial styles don't interfere with mini-fqs component styles.

### 2. Project Preferences
- **Minimalism**: Avoid feature creep; focus on core transcription use case.
- **Quality over quantity**: Fewer, well-explained examples are better than many confusing ones.
- **User-centered design**: Prioritize the choral singer's workflow and needs.

### 3. Documentation Standards
- **Memory bank discipline**: Update documentation with each significant change.
- **Clear examples**: Each tutorial example should have a specific learning objective.
- **Consistent formatting**: Maintain consistent structure across all tutorial sections.

## Learnings and Project Insights

### 1. User Needs
- Choral singers value quick transcription over full-score notation features.
- PDF compatibility with annotation apps is a critical requirement.
- Musicians appreciate seeing the relationship between text notation and standard notation.

### 2. Technical Insights
- PEG.js provides excellent error messages for syntax learning.
- SVG rendering is sufficient for single-line scores and offers styling flexibility.
- Web Components work well for encapsulating musical notation rendering.
- abcjs requires specific class names for audio controls; CDN URLs may change or be unavailable.
- SynthController API is more reliable than CreateSynth + TimingCallbacks for abcjs 6.5.2+
- **FQS rhythm conversion**: Each beat is a quarter note; asterisks are attacks, dashes extend previous attack; multiple asterisks divide the beat; tuplets use closest lower power-of-two note value.

### 3. Educational Insights
- Side-by-side comparison (FQS, rendering, standard notation) is effective for translation.
- Progressive examples build confidence and understanding.
- Copy functionality encourages experimentation with the notation.
- Audio playback helps musicians connect notation with sound.

## Dependencies and Blockers

### 1. Content Creation
- Need to create musically appropriate examples for each tutorial section.
- Require verification of standard notation equivalents for accuracy.
- May benefit from input from music educators on pedagogical approach.

### 2. Technical Dependencies
- None external; all tools and libraries are already in place.
- Browser compatibility is a consideration for tutorial delivery.

### 3. Resource Constraints
- Time for creating comprehensive example content.
- Access to target users for testing and feedback.

This active context captures the current state of development, guiding decisions and priorities for the ongoing tutorial implementation.
